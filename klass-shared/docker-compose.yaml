services:
  mariadb:
    image: mariadb:11.7
    profiles: [ migration-testing, migrate-data ]
    container_name: klass_mariadb
    ports:
      - "3306:3306"
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_USER: "klass"
      MARIADB_PASSWORD: ${MARIADB_LOCAL_PASSWORD}
      MARIADB_LOCAL_FILEPATH: ${MARIADB_LOCAL_FILEPATH}
      MARIADB_DATABASE: "klass"
  postgresql:
    image: postgres:17.4
    profiles: [ migration-testing, migrate-data, frontend, api ]
    container_name: klass_postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: "klass"
      POSTGRES_DATABASE: "klass"
      POSTGRES_LOCAL_FILEPATH: ${POSTGRES_LOCAL_FILEPATH}
  klass-api:
    image: target-postgres-image:latest
    command: [ "java", "-jar", "app.war", "--spring.profiles.active=api, postgres-local, skip-indexing, embedded-solr" ]
    container_name: klass-api
    profiles: [ migration-testing, api ]
    depends_on:
      - postgresql
    ports:
      - "8080:8080"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
    environment:
      SPRING_PROFILES_ACTIVE: api, postgres-local, skip-indexing, embedded-solr
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: "klass"
      POSTGRES_INSTANCE: ${POSTGRES_INSTANCE}
  klass-api-mariadb:
    image: source-mariadb-image:latest
    command: [ "java", "-jar", "app.war", "--spring.profiles.active=api, mariadb-local, skip-indexing, embedded-solr" ]
    container_name: klass-api-mariadb
    profiles: [ migration-testing ]
    depends_on:
      - mariadb
    ports:
      - "8082:8080"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_USER: "klass"
      MARIADB_PASSWORD: ${MARIADB_LOCAL_PASSWORD}
      MARIADB_LOCAL_FILEPATH: ${MARIADB_LOCAL_FILEPATH}
      MARIADB_DATABASE: "klass"
      SPRING_PROFILES_ACTIVE: "mariadb-local"
      MARIADB_INSTANCE: ${MARIADB_INSTANCE}

  klass-forvaltning:
    build:
      context: ../klass-forvaltning
      dockerfile: ../klass-forvaltning/Dockerfile
    container_name: klass-forvaltning
    profiles: [ frontend ]
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: frontend, postgres-local, ad-offline, skip-indexing, embedded-solr
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: "klass"
      POSTGRES_INSTANCE: ${POSTGRES_INSTANCE}
