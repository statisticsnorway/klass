# Deploy config for the test cluster
apiVersion: nais.io/v1alpha1
kind: Application
metadata:
  name: klass-solr
  namespace: dapla-metadata
  labels:
    team: dapla-metadata
  annotations:
    nais.io/read-only-file-system: "false"
    nais.io/run-as-user: "8983"
    nais.io/run-as-group: "8983"
spec:
  port: 8983

  filesFrom:
    - persistentVolumeClaim: klass-solr-pvc
      mountPath: /opt/solr/server/solr/mycores/Klass/data
  command:
    - docker-entrypoint.sh
    - solr-precreate
    - Klass
    - -m
    - 1g  # Set heap size

  replicas:
    min: 1
    max: 1
  resources:
    requests:
      cpu: 20m
      memory: 520Mi
    limits:
      memory: 520Mi

  accessPolicy:
    inbound:
      rules:
        - application: klass
        - application: klass-forvaltning

  liveness:
    path: /solr/admin/cores?action=STATUS
    port: 8983
    initialDelay: 60

  readiness:
    path: /solr/admin/cores?action=STATUS
    port: 8983
    initialDelay: 60

  startup:
    path: /solr/admin/cores?action=STATUS
    port: 8983
    initialDelay: 60
