apiVersion: "monitoring.coreos.com/v1"
kind: PrometheusRule
metadata:
  name: alert-klass-api
  namespace: dapla-metadata
  labels:
    team: dapla-metadata
spec:
  groups:
    - name: dapla-metadata
      rules:
        - alert: High heap memory usage
          expr: (100 * sum by (instance) (jvm_memory_used_bytes{application="klass", area="heap"})) / (sum by (instance) (jvm_memory_max_bytes{application="klass", area="heap"}) ) > 70.0
          for: 3m
          annotations:
            title: "High heap memory usage"
            consequence: "If this increase continues then the app could run out of memory and either lock or crash."
            action: "Immediate: Restart the app from the Nais console\nShort term: Investigate the cause of high heap usage and either fix the bug or "
          labels:
            service: klass-api
            namespace: dapla-metadata
            severity: critical
            environment: test

        - alert: High number of errors
          expr: (100 * sum by (app, namespace) (rate(logback_events_total{application="klass",level="error"}[3m])) / sum by (app, namespace) (rate(logback_events_total{application="klass"}[3m]))) > 1
          for: 3m
          annotations:
            title: "High number of errors logged"
            consequence: "There can be different causes for errors, check logs for cause and evaluation of consequences."
            action: "`kubectl describe pod -l app=klass-api -n dapla-metadata` -> `kubectl logs <podname>`"
          labels:
            service: klass-api
            namespace: dapla-metadata
            severity: critical
            environment: test

        - alert: A Klass-api client is unavailable
          expr: rate(http_client_requests_seconds_count{application="klass", status!="200"}[1m]) > 0
          for: 1m
          annotations:
            title: "A Klass-api client is unavailable "
            consequence: "The service may lack some functionality"
            description: "Client {{ $labels.serviceId }} responded with {{ $labels.status }} causing {{ $labels.exception }}"
          labels:
            service: klass-api
            namespace: dapla-metadata
            severity: critical
            environment: test

        - alert: Klass-api is unavailable
          expr: kube_deployment_status_replicas_available{deployment="klass-api"} == 0
          for: 1m
          annotations:
            title: "Klass-api is unavailable"
            consequence: "Service is unavailable to users. "
          labels:
            service: klass-api
            namespace: dapla-metadata
            severity: critical
            environment: test
